# ğŸ§© Deepspeed-diffusers

*Read this in [English](README_en.md).*

`deepspeed-diffusers` æ˜¯ä¸€ä¸ªåŸç”Ÿç»“åˆ`Deepspeed`ã€`Diffusers`ã€`Peft`åº“æ¥è®­ç»ƒæ‰©æ•£æ¨¡å‹ï¼ˆDiffusion Modelsï¼‰çš„é¡¹ç›®ã€‚

## åŠ¨æœº
è®­ç»ƒè¿‡`Diffusers`çš„å¼€å‘è€…éƒ½çŸ¥é“ç›®å‰å·²ç»æœ‰äº†`Huggingface`å¦ä¸€ä¸ªäº§å“`Accelerate`æ¥å¹¶è¡Œè®­ç»ƒæ‰©æ•£æ¨¡å‹ã€‚

ä¸ºä»€ä¹ˆæˆ‘è¿˜å¼€æºäº†è¿™ä¸ªé¡¹ç›®å‘¢ï¼Ÿ
- ä¸€ä¸ªéå¸¸æ»‘ç¨½çš„äº‹å®æ˜¯å½“åˆæˆ‘æ²¡æœ‰ä»”ç»†çœ‹åˆ°`diffusers`çš„è®­ç»ƒç¤ºä¾‹æ–‡ä»¶æ˜¯éƒ¨åˆ†æ”¯æŒ`Zero3`è€Œä¸æ˜¯ä¸æ”¯æŒã€‚æœ¬é¡¹ç›®æœ€åå®ç°ä¸‹æ¥ï¼Œç»“æœ`Zero3`å®ç°æ€è·¯ä¸å…¶ä¸è°‹è€Œå’Œã€‚
- å¯ä»¥å®‰æ…°è‡ªå·±çš„æ˜¯ï¼Œè™½ç„¶ç°åœ¨é›†æˆæ¡†æ¶å¾ˆå¤šï¼Œä½¿ç”¨èµ·æ¥ä¹Ÿå¾ˆä¾¿æ·ï¼Œä½†æ˜¯é›†æˆçš„ä¸œè¥¿å¤ªå¤šäº†ï¼Œå°±ä¸å®¹æ˜“äºŒæ¬¡å¼€å‘äº†ï¼
- `Slurm`è°ƒåº¦ç³»ç»Ÿçš„è„šæœ¬èµ·ç æˆ‘ä¹Ÿæä¾›äº†ï¼Œä½¿ç”¨å’Œä¿®å¤äº†`Deepspeed`æœ¬æ¥å°±æ”¯æŒå´åˆä¸å¤ªè¡Œçš„`Slurm`å¯åŠ¨å™¨ã€‚

> ä¸ºäº†å……åˆ†å•ç‹¬å‘æŒ¥`Deepspeed`çš„èƒ½åŠ›ï¼Œæœ¬é¡¹ç›®å°±è¿™ä¹ˆè¯ç”Ÿäº†ã€‚

æ­¤å¤–ï¼Œæœ¬é¡¹ç›®åœ¨åŸç”Ÿç»“åˆçš„æ—¶å€™ä¹Ÿå€Ÿé‰´äº†[OvJat](https://github.com/OvJat/DeepSpeedTutorial) ã€[afiaka87](https://github.com/afiaka87/latent-diffusion-deepspeed)ã€[liucongg](https://github.com/liucongg/ChatGLM-Finetuning)çš„ä»£ç ï¼Œåœ¨æ­¤éå¸¸æ„Ÿè°¢è¿™äº›é¡¹ç›®çš„ä»˜å‡ºï¼

åœ¨è¿™äº›é¡¹ç›®ä¸­ï¼Œæœ¬é¡¹ç›®çš„ç¼ºç‚¹æ˜¯ä»€ä¹ˆï¼Ÿ

1. æˆ‘åœ¨å®ç°çš„æ—¶å€™ï¼Œ`ZeRO-1,2`ä¹Ÿåªæ”¯æŒ`UNet2DConditionModel`ã€‚ç›®å‰æˆ‘è¿˜æ²¡æœ‰å‘ç°æˆ‘å·®åˆ«äººå…·ä½“åœ¨å“ªï¼Œè¿˜å¾—å……åˆ†æµ‹è¯•ã€‚
2. æ— æ³•ä¿å­˜Loraè®­ç»ƒæ—¶å€™çš„æ£€æµ‹ç‚¹ï¼Œè¿™å’Œ`Peft`åº“å¤ªè¿‡é›†æˆç»‘å®šæœ‰äº›å…³ç³»ï¼Œé™¤éè‡ªå·±å†™ä¸ªLoraå¾®è°ƒé€»è¾‘ã€‚

é™¤æ­¤ä¹‹å¤–ï¼Œ`Accelerate`æœ‰çš„åŠŸèƒ½æœ¬é¡¹ç›®ä¹Ÿæœ‰ï¼Œæœ¬é¡¹ç›®ä¸»æ‰“ä¸€ä¸ªç®€æ´å®ç”¨ğŸ¥¹

## æœ€è¿‘æ›´æ–° ğŸ”¥

- [2024/05/30] ç±»ä¼¼`Accelerate`ç¤ºä¾‹ï¼Œä¸æŠŠ`stable diffusion`ç±»å®Œå…¨åŠ å…¥DeepSpeedï¼Œä»…åŠ è½½`Unet`ï¼Œè¿™æ ·å‡å°‘äº†å¤§æ¦‚3GB+çš„æ˜¾å­˜
- [2024/05/25] æ”¯æŒæ•°æ®é›†è‡ªå®šä¹‰ï¼Œæ”¯æŒEMA
- [2024/04/18] ä¿®å¤è®­ç»ƒæ–‡æœ¬ä¸åŒ¹é…çš„é—®é¢˜ï¼Œå¢åŠ æ¨ç†éªŒè¯
- [2024/04/10] æ”¯æŒ`slurm`å¤šèŠ‚ç‚¹å’Œå•èŠ‚ç‚¹è®­ç»ƒã€‚
- [2024/04/01] æ”¯æŒ`wandb`ã€‚
- [2024/03/31] æ”¯æŒ`lora`å¾®è°ƒï¼Œä¿®å¤äº†å…¨é‡å¾®è°ƒåçš„ç”Ÿæˆå›¾ç‰‡æ€»æ˜¯é»‘è‰²å›¾ç‰‡çš„é—®é¢˜ï¼Œå¢åŠ äº†`slurm`å•èŠ‚ç‚¹è®­ç»ƒè„šæœ¬
- [2024/03/29] **`deepspeed-diffusers`** å‘å¸ƒäº†ï¼Œæ”¯æŒ`Unet`å…¨é‡å¾®è°ƒã€‚

## æ¼”ç¤º

### å®‰è£…ä¾èµ–

åœ¨è¿è¡Œè„šæœ¬ä¹‹å‰ï¼Œè¯·ç¡®å®šå®‰è£…äº†æ‰€æœ‰çš„ä¾èµ–ï¼š

- è¯·ä¿è¯æºç æ˜¯æœ€æ–°çš„ï¼š`git clone https://github.com/dyedd/deepspeed-diffusers`
- ç„¶å`cd`åˆ°æ–‡ä»¶å¤¹å¹¶è¿è¡Œï¼š`pip -r install requirements.txt`

### [å®å¯æ¢¦æ•°æ®é›†](https://huggingface.co/datasets/lambdalabs/pokemon-blip-captions)ç¤ºä¾‹

> å¼ºçƒˆæ¨èç›´æ¥æŠŠæ•°æ®é›†ä¸‹è½½åˆ°æœ¬åœ°ï¼Œè€Œä¸æ˜¯é€šè¿‡è„šæœ¬è‡ªåŠ¨ä¸‹è½½çš„æ˜¯ç¼“å­˜æ–‡ä»¶ã€‚å¦åˆ™å“ªå¤©æ–­ç½‘ä¹Ÿè¦æ–­`Huggingface`çš„æ•°æ®åé¦ˆä»¥åŠå¯¹äºå›½å†…ç¯å¢ƒä¸æ˜¯éå¸¸å‹å¥½ã€‚

æ ¹æ®ä¸‹è½½çš„ç›®å½•ï¼Œä¿®æ”¹cfg.jsonçš„`dataset_dir`å†…å®¹ã€‚

### ä¸‹è½½æƒé‡

æ¥ä¸‹æ¥çš„ç¤ºä¾‹ç»“æœéƒ½æ˜¯åœ¨[stable-diffusion-1.5](https://huggingface.co/runwayml/stable-diffusion-v1-5)çš„æƒé‡ä¸‹å®éªŒçš„ã€‚

æ³¨æ„ï¼šå¦‚æœæ‚¨ä½¿ç”¨ [stable-diffusion-2](https://huggingface.co/stabilityai/stable-diffusion-2) 768x768
æ¨¡å‹ï¼Œè¯·å°†`cfg/default.json`çš„`resolution`æ›´æ”¹ä¸º 768ã€‚

åœ¨æ­¤ï¼Œä»ç„¶å¼ºçƒˆè‡ªå·±ä¸‹è½½`git clone`æƒé‡ï¼Œä¸è¦é€šè¿‡huggingfaceè‡ªåŠ¨ä¸‹è½½~ç„¶åä¿®æ”¹`cfg/default.json`çš„`pretrained_model_name_or_path`ã€‚


### é…ç½®æ–‡ä»¶è§£è¯»
é¡¹ç›®æ‰€éœ€çš„å‚æ•°éƒ½å†™åœ¨äº†`cfg/default.json`ï¼š
ä»¥ä¸‹æ˜¯æ¯ä¸ªå­—æ®µçš„è§£é‡Šï¼š
- "num_epochs": è®­ç»ƒçš„æ€»è½®æ•°ã€‚
- "validation_epochs": æ¯å¤šå°‘è½®è¿›è¡Œä¸€æ¬¡éªŒè¯ã€‚
- "max_train_steps": é™åˆ¶æœ€å¤§è®­ç»ƒæ­¥æ•°ï¼Œ0è¡¨ç¤ºä¸é™åˆ¶ã€‚
- "lr_warmup_steps": å­¦ä¹ ç‡é¢„çƒ­çš„æ­¥æ•°ã€‚
- "save_interval": æ¨¡å‹ä¿å­˜çš„é—´éš”æ­¥æ•°ã€‚
- "seed": éšæœºç§å­ï¼Œç”¨äºç¡®ä¿å®éªŒçš„å¯é‡å¤æ€§ã€‚
- "validation_prompts": éªŒè¯æ—¶ä½¿ç”¨çš„æç¤ºã€‚
- "pretrained_model_name_or_path": é¢„è®­ç»ƒæ¨¡å‹çš„åç§°æˆ–è·¯å¾„ã€‚
- "dataset_dir": æ•°æ®é›†çš„ç›®å½•ã€‚
- "imagefolder": æ˜¯å¦ä½¿ç”¨åŒ…å«**å›¾åƒ**çš„æ–‡ä»¶å¤¹ä½œä¸ºæ•°æ®æºã€‚
- "checkpoint_dir": æ£€æŸ¥ç‚¹ï¼ˆæ¨¡å‹çŠ¶æ€ï¼‰ä¿å­˜çš„ç›®å½•ã€‚
- "output_dir": è¾“å‡ºï¼ˆå¦‚è®­ç»ƒæ—¥å¿—ã€ç”Ÿæˆçš„å›¾åƒç­‰ï¼‰çš„ç›®å½•ã€‚
- "use_lora": æ˜¯å¦ä½¿ç”¨LoRAï¼ˆLong Range Attentionï¼‰æŠ€æœ¯ï¼Œä»¥åŠç›¸å…³çš„å‚æ•°ã€‚
  - "action": æ˜¯å¦å¯ç”¨LoRAã€‚
  - "rank": LoRAçš„ç§©ã€‚
  - "alpha": LoRAçš„Î±å‚æ•°ã€‚
- "dataloader_num_workers": æ•°æ®åŠ è½½å™¨çš„å·¥ä½œçº¿ç¨‹æ•°ã€‚
- "resume_from_checkpoint": æ˜¯å¦ä»æ£€æŸ¥ç‚¹æ¢å¤è®­ç»ƒã€‚
- "use_ema": æ˜¯å¦ä½¿ç”¨æŒ‡æ•°ç§»åŠ¨å¹³å‡ï¼ˆExponential Moving Averageï¼‰ã€‚
- "offline": æ˜¯å¦åœ¨`wandb`ç¦»çº¿æ¨¡å¼ä¸‹è¿è¡Œã€‚
- "resolution": å›¾åƒçš„åˆ†è¾¨ç‡ã€‚
- "center_crop": æ˜¯å¦å¯¹å›¾åƒè¿›è¡Œä¸­å¿ƒè£å‰ªã€‚
- "random_flip": æ˜¯å¦å¯¹å›¾åƒè¿›è¡Œéšæœºç¿»è½¬ã€‚
- ä¹‹åéƒ½æ˜¯`DeepSpeed`å¸¸ç”¨çš„é…ç½®ï¼Œå¦‚æœ‰ä¸è§£ï¼Œè¯·æŸ¥çœ‹å®˜æ–¹æ–‡æ¡£ã€‚å¦‚æœæœ‰æ·»åŠ ï¼Œä¸è¦å¿˜è®°åŒæ—¶ä¿®æ”¹`utils.py`çš„`deepspeed_config_from_args`å‡½æ•°ã€‚

### è®­ç»ƒ

æœ¬é¡¹ç›®æ”¯æŒ2ç§è®­ç»ƒæ¨¡å¼ã€‚

- å…¨é‡å¾®è°ƒunetï¼Œåœ¨æ··åˆç²¾åº¦FP16ä¸‹ï¼Œå¦‚æœä¸å¼€å¯Zeroï¼Œæ¯å¼ å¡çš„bacth_sizeä¸º4, æ˜¾å­˜å¤§è‡´åœ¨11.61åˆ°23.32GBã€‚
- Lora+unetï¼Œåœ¨æ··åˆç²¾åº¦FP16ä¸‹ï¼Œå¦‚æœä¸å¼€å¯Zeroï¼Œæ¯å¼ å¡çš„bacth_sizeä¸º4, æ˜¾å­˜å¤§è‡´åœ¨2åˆ°13GBã€‚

> åªè¦å¼€å¯æ¢¯åº¦ç´¯ç§¯å’ŒZeroï¼Œé‚£ä¹ˆå…¨é‡å¾®è°ƒä¹Ÿèƒ½å®ç°å®ç°16GBä»¥ä¸‹çš„æ˜¾å¡è®­ç»ƒäº†ï¼


å¦‚æœä½ åœ¨æœ¬åœ°ï¼Œå¯ä»¥ç›´æ¥é€šè¿‡`bash scripts/train_text_to_image.sh`è¿è¡Œè„šæœ¬ï¼›

å¦‚æœä½ åœ¨slurmç³»ç»Ÿï¼Œåœ¨ä¿®æ”¹éƒ¨åˆ†ä¿¡æ¯åï¼Œå¯ä»¥é€šè¿‡`sbatch scripts/train_text_to_image.slurm`ä¸‹æäº¤ã€‚

### æ¨ç†/é‡‡æ ·
åŒæ ·æ”¯æŒæœ¬åœ°å’ŒSlurmè°ƒåº¦ï¼Œå‘½ä»¤åˆ†åˆ«ä¸º
```
bash scripts/test_text_to_image.sh
sbatch scripts/test_text_to_image.slurm
```

## å¯èƒ½å‡ºç°çš„é—®é¢˜

> [!NOTE]
> 1. ç”Ÿæˆçš„å›¾åƒéƒ½æ˜¯é»‘è‰²å›¾ç‰‡æˆ–è€…æŠ¥é”™`RuntimeWarning: invalid value encountered in cast images = (images * 255).round().astype("uint8")`
>
> è¯·æ³¨æ„ï¼Œæœ¬é¡¹ç›®é…ç½®æ–‡ä»¶ä¸­å…³äºä¼˜åŒ–å™¨ï¼Œå­¦ä¹ ç‡çš„å‚æ•°ä»…å¯¹äºå®å¯æ¢¦è¿™ä¸ªæ•°æ®é›†è€Œè¨€ã€‚è¿™ä¸ªé—®é¢˜æ˜¯å› ä¸ºä¼˜åŒ–å™¨ï¼Œå­¦ä¹ ç‡ä¸é€‚åˆè®­ç»ƒé›†ï¼Œè€Œé€ æˆè®­ç»ƒçš„æŸå¤±ä¸€ç›´æ˜¯noneã€‚
> 2. æäº¤çš„`slurm`è„šæœ¬è¿è¡Œæ—¶é—´ä¸º0ç§’å°±é€€å‡º
> è¿™æ˜¯å› ä¸º`slurm`è„šæœ¬é‡Œå†™äº†æ—¥å¿—ä¿å­˜åœ¨`log`æ–‡ä»¶å¤¹ï¼Œè€Œè¯¥æ–‡ä»¶å¤¹ç›®å‰ä¸å­˜åœ¨ï¼Œå°±æ— æ³•è¿è¡Œã€‚

## å¼•ç”¨
å¦‚æœæ‚¨åœ¨è®ºæ–‡å’Œé¡¹ç›®ä¸­ä½¿ç”¨äº†`Deepspeed-diffusers`ï¼Œè¯·ä½¿ç”¨ä»¥ä¸‹`BibTeX`å¼•ç”¨å®ƒã€‚
```
@Misc{Deepspeed-diffusers,
  title =        {Deepspeed-diffusers: training diffusers with deepspeed.},
  author =       {Ximiao Dong},
  howpublished = {\url{https://github.com/dyedd/deepspeed-diffusers}},
  year =         {2024}
}
```